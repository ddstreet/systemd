From: Nick Rosbrook <nick.rosbrook@canonical.com>
Date: Tue, 21 Jun 2022 10:52:39 -0400
Subject: test: increase QEMU_MEM for some tests

These tests have a tendency to fail with OOM on the autopkgtest
infrastructure. Increase QEMU_MEM to try and alleviate that.
---
 test/TEST-08-ISSUE-2730/test.sh         | 1 +
 test/TEST-09-ISSUE-2691/test.sh         | 1 +
 test/TEST-11-ISSUE-3166/test.sh         | 1 +
 test/TEST-13-NSPAWN-SMOKE/test.sh       | 2 ++
 test/TEST-14-MACHINE-ID/test.sh         | 2 ++
 test/TEST-17-UDEV/test.sh               | 1 +
 test/TEST-19-DELEGATE/test.sh           | 1 +
 test/TEST-24-CRYPTSETUP/test.sh         | 1 +
 test/TEST-29-PORTABLE/test.sh           | 2 ++
 test/TEST-30-ONCLOCKCHANGE/test.sh      | 2 ++
 test/TEST-31-DEVICE-ENUMERATION/test.sh | 1 +
 test/TEST-32-OOMPOLICY/test.sh          | 1 +
 test/TEST-36-NUMAPOLICY/test.sh         | 2 ++
 test/TEST-38-FREEZER/test.sh            | 2 ++
 test/TEST-50-DISSECT/test.sh            | 1 +
 test/TEST-53-ISSUE-16347/test.sh        | 2 ++
 test/TEST-58-REPART/test.sh             | 2 ++
 test/TEST-61-UNITTESTS-QEMU/test.sh     | 2 ++
 test/TEST-62-RESTRICT-IFACES/test.sh    | 2 ++
 test/TEST-66-DEVICE-ISOLATION/test.sh   | 2 ++
 test/TEST-67-INTEGRITY/test.sh          | 1 +
 test/TEST-70-TPM2/test.sh               | 1 +
 22 files changed, 33 insertions(+)

--- a/test/TEST-08-ISSUE-2730/test.sh
+++ b/test/TEST-08-ISSUE-2730/test.sh
@@ -10,5 +10,6 @@
 . "${TEST_BASE_DIR:?}/test-functions"
 
 TEST_FORCE_NEWIMAGE=1
+QEMU_MEM="1024M"
 
 do_test "$@"
--- a/test/TEST-09-ISSUE-2691/test.sh
+++ b/test/TEST-09-ISSUE-2691/test.sh
@@ -8,4 +8,6 @@
 # shellcheck source=test/test-functions
 . "${TEST_BASE_DIR:?}/test-functions"
 
+QEMU_MEM="1024M"
+
 do_test "$@"
--- a/test/TEST-11-ISSUE-3166/test.sh
+++ b/test/TEST-11-ISSUE-3166/test.sh
@@ -8,4 +8,6 @@
 # shellcheck source=test/test-functions
 . "${TEST_BASE_DIR:?}/test-functions"
 
+QEMU_MEM="1024M"
+
 do_test "$@"
--- a/test/TEST-13-NSPAWN-SMOKE/test.sh
+++ b/test/TEST-13-NSPAWN-SMOKE/test.sh
@@ -27,4 +27,6 @@
     )
 }
 
+QEMU_MEM="1024M"
+
 do_test "$@"
--- a/test/TEST-14-MACHINE-ID/test.sh
+++ b/test/TEST-14-MACHINE-ID/test.sh
@@ -13,4 +13,6 @@
     printf "556f48e837bc4424a710fa2e2c9d3e3c\ne3d\n" >"${1:?}/etc/machine-id"
 }
 
+QEMU_MEM="1024M"
+
 do_test "$@"
--- a/test/TEST-17-UDEV/test.sh
+++ b/test/TEST-17-UDEV/test.sh
@@ -8,5 +8,6 @@
 # shellcheck source=test/test-functions
 . "${TEST_BASE_DIR:?}/test-functions"
 
+QEMU_MEM="1024M"
 
 do_test "$@"
--- a/test/TEST-19-DELEGATE/test.sh
+++ b/test/TEST-19-DELEGATE/test.sh
@@ -8,6 +8,7 @@
 # shellcheck source=test/test-functions
 . "${TEST_BASE_DIR:?}/test-functions"
 
+QEMU_MEM="1024M"
 UNIFIED_CGROUP_HIERARCHY=yes
 
 do_test "$@"
--- a/test/TEST-24-CRYPTSETUP/test.sh
+++ b/test/TEST-24-CRYPTSETUP/test.sh
@@ -14,6 +14,7 @@
 DM_NAME="test24_varcrypt"
 KERNEL_APPEND+=" rd.luks=1 luks.name=$PART_UUID=$DM_NAME luks.key=$PART_UUID=/keyfile:LABEL=varcrypt_keydev"
 QEMU_OPTIONS+=" -drive format=raw,cache=unsafe,file=${STATEDIR:?}/keydev.img"
+QEMU_MEM="1024M"
 
 check_result_qemu() {
     local ret=1
--- a/test/TEST-29-PORTABLE/test.sh
+++ b/test/TEST-29-PORTABLE/test.sh
@@ -27,4 +27,6 @@
     )
 }
 
+QEMU_MEM="1024M"
+
 do_test "$@"
--- a/test/TEST-30-ONCLOCKCHANGE/test.sh
+++ b/test/TEST-30-ONCLOCKCHANGE/test.sh
@@ -8,4 +8,6 @@
 # shellcheck source=test/test-functions
 . "${TEST_BASE_DIR:?}/test-functions"
 
+QEMU_MEM="1024M"
+
 do_test "$@"
--- a/test/TEST-31-DEVICE-ENUMERATION/test.sh
+++ b/test/TEST-31-DEVICE-ENUMERATION/test.sh
@@ -8,5 +8,6 @@
 # shellcheck source=test/test-functions
 . "${TEST_BASE_DIR:?}/test-functions"
 
+QEMU_MEM="1024M"
 
 do_test "$@"
--- a/test/TEST-32-OOMPOLICY/test.sh
+++ b/test/TEST-32-OOMPOLICY/test.sh
@@ -9,5 +9,6 @@
 . "${TEST_BASE_DIR:?}/test-functions"
 
 UNIFIED_CGROUP_HIERARCHY=yes
+QEMU_MEM="1024M"
 
 do_test "$@"
--- a/test/TEST-36-NUMAPOLICY/test.sh
+++ b/test/TEST-36-NUMAPOLICY/test.sh
@@ -8,6 +8,8 @@
 # shellcheck source=test/test-functions
 . "${TEST_BASE_DIR:?}/test-functions"
 
+QEMU_MEM="1024M"
+
 if qemu_min_version "5.2.0"; then
     QEMU_OPTIONS+=" -object memory-backend-ram,id=mem0,size=${QEMU_MEM:-768M} -numa node,memdev=mem0,nodeid=0"
 else
--- a/test/TEST-38-FREEZER/test.sh
+++ b/test/TEST-38-FREEZER/test.sh
@@ -8,4 +8,6 @@
 # shellcheck source=test/test-functions
 . "${TEST_BASE_DIR:?}/test-functions"
 
+QEMU_MEM="1024M"
+
 do_test "$@"
--- a/test/TEST-50-DISSECT/test.sh
+++ b/test/TEST-50-DISSECT/test.sh
@@ -12,6 +12,7 @@
 # shellcheck source=test/test-functions
 . "${TEST_BASE_DIR:?}/test-functions"
 
+QEMU_MEM="1024M"
 
 command -v mksquashfs >/dev/null 2>&1 || exit 0
 command -v veritysetup >/dev/null 2>&1 || exit 0
--- a/test/TEST-53-ISSUE-16347/test.sh
+++ b/test/TEST-53-ISSUE-16347/test.sh
@@ -10,4 +10,6 @@
 # shellcheck source=test/test-functions
 . "${TEST_BASE_DIR:?}/test-functions"
 
+QEMU_MEM="1024M"
+
 do_test "$@"
--- a/test/TEST-58-REPART/test.sh
+++ b/test/TEST-58-REPART/test.sh
@@ -18,4 +18,6 @@
     fi
 }
 
+QEMU_MEM="1024M"
+
 do_test "$@"
--- a/test/TEST-61-UNITTESTS-QEMU/test.sh
+++ b/test/TEST-61-UNITTESTS-QEMU/test.sh
@@ -17,6 +17,8 @@
 # shellcheck source=test/test-functions
 . "${TEST_BASE_DIR:?}/test-functions"
 
+QEMU_MEM="1024M"
+
 check_result_nspawn() {
     check_result_nspawn_unittests "${1}"
 }
--- a/test/TEST-62-RESTRICT-IFACES/test.sh
+++ b/test/TEST-62-RESTRICT-IFACES/test.sh
@@ -8,4 +8,6 @@
 # shellcheck source=test/test-functions
 . "$TEST_BASE_DIR/test-functions"
 
+QEMU_MEM="1024M"
+
 do_test "$@"
--- a/test/TEST-66-DEVICE-ISOLATION/test.sh
+++ b/test/TEST-66-DEVICE-ISOLATION/test.sh
@@ -8,4 +8,6 @@
 # shellcheck source=test/test-functions
 . "${TEST_BASE_DIR:?}/test-functions"
 
+QEMU_MEM="1024M"
+
 do_test "$@"
--- a/test/TEST-67-INTEGRITY/test.sh
+++ b/test/TEST-67-INTEGRITY/test.sh
@@ -9,6 +9,8 @@
 # shellcheck source=test/test-functions
 . "${TEST_BASE_DIR:?}/test-functions"
 
+QEMU_MEM="1024M"
+
 test_append_files() {(
 
     instmods loop =block
--- a/test/TEST-70-TPM2/test.sh
+++ b/test/TEST-70-TPM2/test.sh
@@ -40,5 +40,6 @@
 TEST_70_SWTPM_PID=$!
 add_at_exit_handler TEST_70_at_exit
 QEMU_OPTIONS+=" -chardev socket,id=chrtpm,path=$TEST_70_TPM_STATE/sock -tpmdev emulator,id=tpm0,chardev=chrtpm -device $TEST_70_TPM_DEVICE,tpmdev=tpm0"
+QEMU_MEM="1024M"
 
 do_test "$@"
