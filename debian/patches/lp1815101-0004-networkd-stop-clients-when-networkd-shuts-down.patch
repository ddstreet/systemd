Description: networkd: stop clients when networkd shuts down (#12463)
    
    We not stopping the clients when networkd stops. They
    should shut down cleanly and then we need to clean the DS.
    
    One of requirements to implement
    https://github.com/systemd/systemd/issues/10820.
    
    ```
    ^CBus bus-api-network: changing state RUNNING â†’ CLOSED
    DHCP SERVER: UNREF
    DHCP SERVER: STOPPED
    DHCP CLIENT (0x60943df0): STOPPED
    veth-test: DHCP lease lost
    veth-test: Removing address 192.168.5.31
    NDISC: Stopping IPv6 Router Solicitation client
    DHCP CLIENT (0x0): FREE
    ==24308==
    ==24308== HEAP SUMMARY:
    ==24308==     in use at exit: 8,192 bytes in 2 blocks
    ==24308==   total heap usage: 4,230 allocs, 4,228 frees, 1,209,732 bytes allocated
    ==24308==
    ==24308== LEAK SUMMARY:
    ==24308==    definitely lost: 0 bytes in 0 blocks
    ==24308==    indirectly lost: 0 bytes in 0 blocks
    ==24308==      possibly lost: 0 bytes in 0 blocks
    ==24308==    still reachable: 8,192 bytes in 2 blocks
    ==24308==         suppressed: 0 bytes in 0 blocks
    ==24308== Rerun with --leak-check=full to see details of leaked memory
    ==24308==
    ==24308== For lists of detected and suppressed errors, rerun with: -s
    ==24308== ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 0 from 0)
    ==24308== could not unlink /tmp/vgdb-pipe-from-vgdb-to-24308-by-sus-on-Zeus
    ==24308== could not unlink /tmp/vgdb-pipe-to-vgdb-from-24308-by-sus-on-Zeus
    ==24308== could not unlink /tmp/vgdb-pipe-shared-mem-vgdb-24308-by-sus-on-Zeus
    
    ```
Author: Susant Sahani <ssahani@redhat.com>
Origin: backport, https://github.com/systemd/systemd/commit/946f8e14d59ec1262f1779bc9a65d1c048d6544b
Bug-Ubuntu: https://launchpad.net/bugs/1815101
--- a/src/network/networkd-link.c
+++ b/src/network/networkd-link.c
@@ -647,7 +647,7 @@
         link_dirty(link);
 }
 
-static int link_stop_clients(Link *link) {
+int link_stop_clients(Link *link) {
         int r = 0, k;
 
         assert(link);
--- a/src/network/networkd-link.h
+++ b/src/network/networkd-link.h
@@ -184,6 +184,8 @@
 int dhcp6_configure(Link *link);
 int dhcp6_request_address(Link *link, int ir);
 
+int link_stop_clients(Link *link);
+
 const char* link_state_to_string(LinkState s) _const_;
 LinkState link_state_from_string(const char *s) _pure_;
 
--- a/src/network/networkd-manager.c
+++ b/src/network/networkd-manager.c
@@ -1469,6 +1469,7 @@
         hashmap_free(m->dhcp6_prefixes);
 
         while ((link = hashmap_steal_first(m->links))) {
+                link_stop_clients(link);
                 link_unref(link);
          }
 
