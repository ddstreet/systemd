From bfb950ce40cf42e27bb9450ce383609472ea2223 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Zbigniew=20J=C4=99drzejewski-Szmek?= <zbyszek@in.waw.pl>
Date: Tue, 24 Apr 2018 13:45:44 +0200
Subject: [PATCH] Fix three uses of bogus errno value in logs (and returned
 value in one case)

(cherry picked from commit 4355f1c9da0843708426f5c2c8b85179b934a5c7)
---
 src/activate/activate.c | 2 +-
 src/core/bpf-firewall.c | 5 +++--
 2 files changed, 4 insertions(+), 3 deletions(-)

diff --git a/src/activate/activate.c b/src/activate/activate.c
index c856c8c100..e605d50ce0 100644
--- a/src/activate/activate.c
+++ b/src/activate/activate.c
@@ -201,7 +201,7 @@ static int exec_process(const char* name, char **argv, char **env, int start_fd,
 
                 r = rearrange_stdio(start_fd, start_fd, STDERR_FILENO); /* invalidates start_fd on success + error */
                 if (r < 0)
-                        return log_error_errno(errno, "Failed to move fd to stdin+stdout: %m");
+                        return log_error_errno(r, "Failed to move fd to stdin+stdout: %m");
 
         } else {
                 if (start_fd != SD_LISTEN_FDS_START) {
diff --git a/src/core/bpf-firewall.c b/src/core/bpf-firewall.c
index 48666f64a2..deebafbf47 100644
--- a/src/core/bpf-firewall.c
+++ b/src/core/bpf-firewall.c
@@ -705,13 +705,14 @@ int bpf_firewall_supported(void) {
                          1,
                          BPF_F_NO_PREALLOC);
         if (fd < 0) {
-                log_debug_errno(r, "Can't allocate BPF LPM TRIE map, BPF firewalling is not supported: %m");
+                log_debug_errno(fd, "Can't allocate BPF LPM TRIE map, BPF firewalling is not supported: %m");
                 return supported = BPF_FIREWALL_UNSUPPORTED;
         }
 
         safe_close(fd);
 
-        if (bpf_program_new(BPF_PROG_TYPE_CGROUP_SKB, &program) < 0) {
+        r = bpf_program_new(BPF_PROG_TYPE_CGROUP_SKB, &program);
+        if (r < 0) {
                 log_debug_errno(r, "Can't allocate CGROUP SKB BPF program, BPF firewalling is not supported: %m");
                 return supported = BPF_FIREWALL_UNSUPPORTED;
         }
-- 
2.17.0

