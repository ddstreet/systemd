From: Dan Streetman <ddstreet@canonical.com>
Subject: Revert patch lp1929560-network-move-set-MAC-and-set-nomaster-operations-out.patch
Bug-Ubuntu: https://bugs.launchpad.net/ubuntu/+source/systemd/+bug/1937117

--- systemd-237.orig/src/network/networkd-link.c
+++ systemd-237/src/network/networkd-link.c
@@ -1332,105 +1332,6 @@ static int link_set_handler(sd_netlink *
 
 static int link_configure_continue(Link *link);
 
-static int link_mac_handler(sd_netlink *rtnl, sd_netlink_message *m, void *userdata) {
-        _cleanup_link_unref_ Link *link = userdata;
-        int r;
-
-        assert(link);
-
-        if (IN_SET(link->state, LINK_STATE_FAILED, LINK_STATE_LINGER))
-                return 1;
-
-        r = sd_netlink_message_get_errno(m);
-        if (r < 0)
-                log_link_warning_errno(link, r, "Could not set MAC address, ignoring: %m");
-        else
-                log_link_debug(link, "Setting MAC address done.");
-
-        return 1;
-}
-
-static int link_set_mac(Link *link) {
-        _cleanup_(sd_netlink_message_unrefp) sd_netlink_message *req = NULL;
-        int r;
-
-        assert(link);
-        assert(link->network);
-        assert(link->manager);
-        assert(link->manager->rtnl);
-
-        if (!link->network->mac)
-                return 0;
-
-        log_link_debug(link, "Setting MAC address");
-
-        r = sd_rtnl_message_new_link(link->manager->rtnl, &req, RTM_SETLINK, link->ifindex);
-        if (r < 0)
-                return log_link_error_errno(link, r, "Could not allocate RTM_SETLINK message: %m");
-
-        r = sd_netlink_message_append_ether_addr(req, IFLA_ADDRESS, link->network->mac);
-        if (r < 0)
-                return log_link_error_errno(link, r, "Could not set MAC address: %m");
-
-        r = sd_netlink_call_async(link->manager->rtnl, req, link_mac_handler, link, 0, NULL);
-        if (r < 0)
-                return log_link_error_errno(link, r, "Could not send rtnetlink message: %m");
-
-        link_ref(link);
-
-        return 0;
-}
-
-static int link_nomaster_handler(sd_netlink *rtnl, sd_netlink_message *m, void *userdata) {
-        _cleanup_link_unref_ Link *link = userdata;
-        int r;
-
-        assert(link);
-
-        if (IN_SET(link->state, LINK_STATE_FAILED, LINK_STATE_LINGER))
-                return 1;
-
-        r = sd_netlink_message_get_errno(m);
-        if (r < 0)
-                log_link_warning_errno(link, r, "Could not set nomaster, ignoring: %m");
-        else
-                log_link_debug(link, "Setting nomaster done.");
-
-        return 1;
-}
-
-static int link_set_nomaster(Link *link) {
-        _cleanup_(sd_netlink_message_unrefp) sd_netlink_message *req = NULL;
-        int r;
-
-        assert(link);
-        assert(link->network);
-        assert(link->manager);
-        assert(link->manager->rtnl);
-
-        /* set it free if not enslaved with networkd */
-        if (link->network->bridge || link->network->bond || link->network->vrf)
-                return 0;
-
-        log_link_debug(link, "Setting nomaster");
-
-        r = sd_rtnl_message_new_link(link->manager->rtnl, &req, RTM_SETLINK, link->ifindex);
-        if (r < 0)
-                return log_link_error_errno(link, r, "Could not allocate RTM_SETLINK message: %m");
-
-        r = sd_netlink_message_append_u32(req, IFLA_MASTER, 0);
-        if (r < 0)
-                return log_link_error_errno(link, r, "Could not append IFLA_MASTER attribute: %m");
-
-        r = sd_netlink_call_async(link->manager->rtnl, req, link_nomaster_handler, link, 0, NULL);
-        if (r < 0)
-                return log_link_error_errno(link, r, "Could not send rtnetlink message: %m");
-
-        link_ref(link);
-
-        return 0;
-}
-
 static int set_mtu_handler(sd_netlink *rtnl, sd_netlink_message *m, void *userdata) {
         _cleanup_link_unref_ Link *link = userdata;
         int r;
@@ -1999,10 +1900,23 @@ int link_up(Link *link) {
         if (r < 0)
                 return log_link_error_errno(link, r, "Could not allocate RTM_SETLINK message: %m");
 
+        /* set it free if not enslaved with networkd */
+        if (!link->network->bridge && !link->network->bond && !link->network->vrf) {
+                r = sd_netlink_message_append_u32(req, IFLA_MASTER, 0);
+                if (r < 0)
+                        return log_link_error_errno(link, r, "Could not append IFLA_MASTER attribute: %m");
+        }
+
         r = sd_rtnl_message_link_set_flags(req, IFF_UP, IFF_UP);
         if (r < 0)
                 return log_link_error_errno(link, r, "Could not set link flags: %m");
 
+        if (link->network->mac) {
+                r = sd_netlink_message_append_ether_addr(req, IFLA_ADDRESS, link->network->mac);
+                if (r < 0)
+                        return log_link_error_errno(link, r, "Could not set MAC address: %m");
+        }
+
         r = sd_netlink_call_async(link->manager->rtnl, req, link_up_handler, link, 0, NULL);
         if (r < 0)
                 return log_link_error_errno(link, r, "Could not send rtnetlink message: %m");
@@ -2940,14 +2854,6 @@ static int link_configure(Link *link) {
         if (r < 0)
                 return r;
 
-        r = link_set_mac(link);
-        if (r < 0)
-                return r;
-
-        r = link_set_nomaster(link);
-        if (r < 0)
-                return r;
-
         r = link_set_flags(link);
         if (r < 0)
                 return r;
