From: Felipe Sateler <fsateler@gmail.com>
Date: Wed, 12 Oct 2016 11:56:27 -0300
Subject: build-sys: Allow disabling installation of pam config snippet

Cherry-picked from commit 651742d8ecd62d718080329fbba805bf364e6c25
---
 DISTRO_PORTING | 10 ++++++++++
 Makefile.am    |  2 ++
 configure.ac   |  3 ++-
 3 files changed, 14 insertions(+), 1 deletion(-)

diff --git a/DISTRO_PORTING b/DISTRO_PORTING
index 07aea86..d86b61e 100644
--- a/DISTRO_PORTING
+++ b/DISTRO_PORTING
@@ -40,6 +40,16 @@ NTP POOL:
         NTP servers, then you will get served wrong time, and will
         rely on services that might not be supported for long.
 
+PAM:
+        The default PAM config shipped by systemd is really bare bones.
+        It does not include many modules your distro might want to enable
+        to provide a more seamless experience. For example, limits set in
+        /etc/security/limits.conf will not be read unless you load pam_limits.
+        Make sure you add modules your distro expects from user services.
+
+        Pass --with-pamconfdir=no to ./configure to avoid installing this file
+        and instead install your own.
+
 CONTRIBUTING UPSTREAM:
 
         We generally do no longer accept distribution-specific
diff --git a/Makefile.am b/Makefile.am
index 665abc6..f1d5219 100644
--- a/Makefile.am
+++ b/Makefile.am
@@ -5839,8 +5839,10 @@ pam_systemd_la_LIBADD = \
 pamlib_LTLIBRARIES = \
 	pam_systemd.la
 
+if ENABLE_PAM_CONFIG
 dist_pamconf_DATA = \
 	src/login/systemd-user
+endif
 
 EXTRA_DIST += \
 	src/login/systemd-user.m4
diff --git a/configure.ac b/configure.ac
index cf595e6..fe2cad0 100644
--- a/configure.ac
+++ b/configure.ac
@@ -1486,9 +1486,10 @@ AC_ARG_WITH([pamlibdir],
 AX_NORMALIZE_PATH([with_pamlibdir])
 
 AC_ARG_WITH([pamconfdir],
-        AS_HELP_STRING([--with-pamconfdir=DIR], [Directory for PAM configuration]),
+        AS_HELP_STRING([--with-pamconfdir=DIR], [Directory for PAM configuration (pass no to disable installing)]),
         [],
         [with_pamconfdir=${sysconfdir}/pam.d])
+AM_CONDITIONAL(ENABLE_PAM_CONFIG, [test "$with_pamconfdir" != "no"])
 AX_NORMALIZE_PATH([with_pamconfdir])
 
 AC_ARG_ENABLE([split-usr],
