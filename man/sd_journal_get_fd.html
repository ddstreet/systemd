<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>sd_journal_get_fd</title><meta name="generator" content="DocBook XSL Stylesheets V1.77.1"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><a href="index.html">Index </a>·
  <a href="systemd.directives.html">Directives </a>·
  <a href="../python-systemd/index.html">Python </a>·
  <a href="../libudev/index.html">libudev </a>·
  <a href="../libudev/index.html">gudev </a><hr><div class="refentry"><a name="sd_journal_get_fd"></a><div class="titlepage"></div><div class="refnamediv"><h2>Name</h2><p>sd_journal_get_fd, sd_journal_reliable_fd, sd_journal_process, sd_journal_wait, SD_JOURNAL_NOP, SD_JOURNAL_APPEND, SD_JOURNAL_INVALIDATE — Journal change notification
                interface</p></div><div class="refsynopsisdiv"><h2>Synopsis</h2><div class="funcsynopsis"><pre class="funcsynopsisinfo">#include &lt;systemd/sd-journal.h&gt;</pre><table border="0" class="funcprototype-table" summary="Function synopsis" style="cellspacing: 0; cellpadding: 0;"><tr><td><code class="funcdef">int <b class="fsfunc">sd_journal_get_fd</b>(</code></td><td>sd_journal* <var class="pdparam">j</var><code>)</code>;</td></tr></table><div class="funcprototype-spacer"> </div><table border="0" class="funcprototype-table" summary="Function synopsis" style="cellspacing: 0; cellpadding: 0;"><tr><td><code class="funcdef">int <b class="fsfunc">sd_journal_reliable_fd</b>(</code></td><td>sd_journal* <var class="pdparam">j</var><code>)</code>;</td></tr></table><div class="funcprototype-spacer"> </div><table border="0" class="funcprototype-table" summary="Function synopsis" style="cellspacing: 0; cellpadding: 0;"><tr><td><code class="funcdef">int <b class="fsfunc">sd_journal_process</b>(</code></td><td>sd_journal* <var class="pdparam">j</var><code>)</code>;</td></tr></table><div class="funcprototype-spacer"> </div><table border="0" class="funcprototype-table" summary="Function synopsis" style="cellspacing: 0; cellpadding: 0;"><tr><td><code class="funcdef">int <b class="fsfunc">sd_journal_wait</b>(</code></td><td>sd_journal* <var class="pdparam">j</var>, </td></tr><tr><td> </td><td>uint64_t <var class="pdparam">timeout_usec</var><code>)</code>;</td></tr></table><div class="funcprototype-spacer"> </div></div></div><div class="refsect1"><a name="idp3974928"></a><h2>Description</h2><p><code class="function">sd_journal_get_fd()</code> returns
                a file descriptor that may be asynchronously polled in
                an external event loop and is signaled readable as
                soon as the journal changes, because new entries or
                files were added, rotation took place, or files have
                been deleted, and similar. The file descriptor is
                suitable for usage in
                <a href="poll.html"><span class="citerefentry"><span class="refentrytitle">poll</span>(2)</span></a>
                where it will yield POLLIN on changes. The call takes
                one argument: the journal context object. Note that
                not all file systems are capable of generating the
                necessary events for wakeups from this file descriptor
                to be enirely reliable. In particular network files
                systems do not generate suitable file change events in
                all cases. In such a case an application should not
                rely alone on wake-ups from this file descriptor but
                wake up and recheck the journal in regular time
                intervals, for example every 2s. To detect
                cases where this is necessary, use
                <code class="function">sd_journal_reliable_fd()</code>,
                below.</p><p><code class="function">sd_journal_reliable_fd()</code>
                may be used to check whether the wakeup events from
                the file descriptor returned by
                <code class="function">sd_journal_get_fd</code> are sufficient
                to track changes to the journal. If this call returns
                0, it is necessary to regularly recheck for journal
                changes (suggestion: every 2s). If this call returns a
                positive integer this is not necessary, and wakeups
                from the file descriptor returned by
                <code class="function">sd_journal_get_fd()</code> are
                sufficient as only source for wake-ups.</p><p>After each POLLIN wake-up
                <code class="function">sd_journal_process()</code> needs to be
                called to process events and reset the readable state
                of the file descriptor. This call will also indicate
                what kind of change has been detected (see below; note
                that spurious wake-ups are possible).</p><p>A synchronous alternative for using
                <code class="function">sd_journal_get_fd()</code>,
                <code class="function">sd_journal_reliable_fd()</code> and
                <code class="function">sd_journal_process()</code> is
                <code class="function">sd_journal_wait()</code>. It will
                synchronously wait until the journal gets changed,
                possibly using a 2s time-out if this is necessary (see
                above). In either way the maximum time this call
                sleeps may be controlled with the
                <em class="parameter"><code>timeout_usec</code></em> parameter. Pass
                <code class="literal">(uint64_t) -1</code> to wait
                indefinitely. Internally this call simply combines
                <code class="function">sd_journal_get_fd()</code>,
                <code class="function">sd_journal_reliable_fd()</code>,
                <code class="function">poll()</code> and
                <code class="function">sd_journal_process()</code> into
                one.</p></div><div class="refsect1"><a name="idp37840"></a><h2>Return Value</h2><p><code class="function">sd_journal_get_fd()</code> returns a valid file descriptor on success or a negative errno-style error
                code.</p><p><code class="function">sd_journal_reliable_fd()</code>
                returns a positive integer if the file descriptor
                returned by <code class="function">sd_journal_get_fd()</code>
                is sufficient as sole wake-up source for journal
                change events. Returns 0 if it is not sufficient and
                the journal needs to be checked manually in regular
                time intervals for changes. Returns a negative
                errno-style error code on failure.</p><p><code class="function">sd_journal_process()</code> and
                <code class="function">sd_journal_wait()</code> return one of
                <code class="literal">SD_JOURNAL_NOP</code>,
                <code class="literal">SD_JOURNAL_APPEND</code> or
                <code class="literal">SD_JOURNAL_INVALIDATE</code> on success or
                a negative errno-style error code. If
                <code class="literal">SD_JOURNAL_NOP</code> is returned the
                journal didn't change since the last invocation. If
                <code class="literal">SD_JOURNAL_APPEND</code> is returned new
                entries have been appended to the end of the
                journal. If <code class="literal">SD_JOURNAL_INVALIDATE</code>
                journal files were added or removed (possibly due to
                rotation). In the latter event live-view UIs should
                probably refresh their entire display while in the
                case of <code class="literal">SD_JOURNAL_APPEND</code> it is
                sufficient to simply continue reading at the previous
                end of the journal.</p></div><div class="refsect1"><a name="idp56304"></a><h2>Notes</h2><p>The <code class="function">sd_journal_get_fd()</code>,
                <code class="function">sd_journal_reliable_fd()</code>,
                <code class="function">sd_journal_process()</code> and
                <code class="function">sd_journal_wait()</code> interfaces are
                available as shared library, which can be compiled and
                linked to with the
                <code class="literal">libsystemd-journal</code>
                <a href="pkg-config.html"><span class="citerefentry"><span class="refentrytitle">pkg-config</span>(1)</span></a>
                file.</p></div><div class="refsect1"><a name="idp62064"></a><h2>Examples</h2><p>Iterating through the journal, in a live view tracking all changes:</p><pre class="programlisting">#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;systemd/sd-journal.h&gt;

int main(int argc, char *argv[]) {
        int r;
        sd_journal *j;
        r = sd_journal_open(&amp;j, SD_JOURNAL_LOCAL_ONLY);
        if (r &lt; 0) {
                fprintf(stderr, "Failed to open journal: %s\n", strerror(-r));
                return 1;
        }
        for (;;)  {
                const void *d;
                size_t l;
                r = sd_journal_next(j);
                if (r &lt; 0) {
                        fprintf(stderr, "Failed to iterate to next entry: %s\n", strerror(-r));
                        break;
                }
                if (r == 0) {
                        /* Reached the end, let's wait for changes, and try again */
                        r = sd_journal_wait(j, (uint64_t) -1);
                        if (r &lt; 0) {
                                fprintf(stderr, "Failed to wait for changes: %s\n", strerror(-r));
                                break;
                        }
                        continue;
                }
                r = sd_journal_get_data(j, "MESSAGE", &amp;d, &amp;l);
                if (r &lt; 0) {
                        fprintf(stderr, "Failed to read message field: %s\n", strerror(-r));
                        continue;
                }
                printf("%.*s\n", (int) l, (const char*) d);
        }
        sd_journal_close(j);
        return 0;
}</pre><p>Waiting with <code class="function">poll()</code> (this
                example lacks all error checking for the sake of
                simplicity):</p><pre class="programlisting">#include &lt;sys/poll.h&gt;
#include &lt;systemd/sd-journal.h&gt;

int wait_for_changes(sd_journal *j) {
        struct pollfd pollfd;
        pollfd.fd = sd_journal_get_fd(j);
        pollfd.events = POLLIN;
        poll(&amp;pollfd, 1, sd_journal_reliable_fd(j) &gt; 0 ? -1 : 2000);
        return sd_journal_process(j);
}
                </pre></div><div class="refsect1"><a name="idp68112"></a><h2>See Also</h2><p>
                        <a href="systemd.html"><span class="citerefentry"><span class="refentrytitle">systemd</span>(1)</span></a>,
                        <a href="sd-journal.html"><span class="citerefentry"><span class="refentrytitle">sd-journal</span>(3)</span></a>,
                        <a href="sd_journal_open.html"><span class="citerefentry"><span class="refentrytitle">sd_journal_open</span>(3)</span></a>,
                        <a href="sd_journal_next.html"><span class="citerefentry"><span class="refentrytitle">sd_journal_next</span>(3)</span></a>,
                        <a href="poll.html"><span class="citerefentry"><span class="refentrytitle">poll</span>(2)</span></a>
                </p></div></div></body></html>
